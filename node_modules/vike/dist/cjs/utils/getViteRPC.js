"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getViteRPC = getViteRPC;
exports.createViteRPC = createViteRPC;
const assert_js_1 = require("./assert.js");
const genPromise_js_1 = require("./genPromise.js");
const getRandomId_js_1 = require("./getRandomId.js");
const getGlobalObject_js_1 = require("./getGlobalObject.js");
const debug_js_1 = require("./debug.js");
const assertIsNotBrowser_js_1 = require("./assertIsNotBrowser.js");
(0, assertIsNotBrowser_js_1.assertIsNotBrowser)();
const globalObject = (0, getGlobalObject_js_1.getGlobalObject)('utils/getViteRPC.ts', {
    rpc: null,
});
const debug = (0, debug_js_1.createDebugger)('vike:vite-rpc');
function getViteRPC() {
    globalObject.rpc ?? (globalObject.rpc = createRpcClient());
    return globalObject.rpc;
}
function createRpcClient() {
    // @ts-ignore CJS build doesn't support import.meta — TO-DO/eventually: let's remove this ts-ignore after we removed the CJS build
    const hot = (undefined);
    (0, assert_js_1.assert)(hot);
    const listeners = [];
    hot.on(`vike:rpc:response`, (dataResponse) => {
        if (debug.isActivated)
            debug('Response received', dataResponse);
        const { callId, functionReturn } = dataResponse;
        listeners.forEach((l) => {
            if (callId !== l.callId)
                return;
            l.cb(functionReturn);
            listeners.splice(listeners.indexOf(l), 1);
        });
    });
    const rpc = new Proxy({}, {
        get(_, functionName) {
            return async (...functionArgs) => {
                // @ts-ignore CJS build doesn't support import.meta — TO-DO/eventually: let's remove this ts-ignore after we removed the CJS build
                const hot = (undefined);
                (0, assert_js_1.assert)(hot);
                const callId = (0, getRandomId_js_1.getRandomId)();
                const { promise, resolve } = (0, genPromise_js_1.genPromise)({ timeout: 3 * 1000 });
                listeners.push({
                    callId,
                    cb: (functionReturn) => {
                        resolve(functionReturn);
                    },
                });
                const dataRequest = { callId, functionName, functionArgs };
                if (debug.isActivated)
                    debug('Request sent', dataRequest);
                // Vite's type is wrong: (undefined).send() does seem to return a promise
                await hot.send('vike:rpc:request', dataRequest);
                const functionReturn = await promise;
                return functionReturn;
            };
        },
    });
    return rpc;
}
function createViteRPC(viteDevServer, getRpcFunctions) {
    const rpcFunctions = getRpcFunctions(viteDevServer);
    const { environments } = viteDevServer;
    for (const envName in environments) {
        debug('Listening to environment', envName);
        const env = environments[envName];
        env.hot.on('vike:rpc:request', async (dataRequest) => {
            if (debug.isActivated)
                debug('Request received', dataRequest);
            const { callId, functionName, functionArgs } = dataRequest;
            const functionReturn = await rpcFunctions[functionName](...functionArgs);
            const dataResponse = { callId, functionReturn };
            if (debug.isActivated)
                debug('Response sent', dataResponse);
            env.hot.send('vike:rpc:response', dataResponse);
        });
    }
}
