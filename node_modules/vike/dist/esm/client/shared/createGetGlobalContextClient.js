// Public usage
export { getGlobalContext };
export { getGlobalContextSync };
// Internal usage
export { createGetGlobalContextClient };
import { createGlobalContextShared, getGlobalContextSyncErrMsg, } from '../../shared/createGlobalContextShared.js';
import { getGlobalContextSerializedInHtml } from './getJsonSerializedInHtml.js';
import { assert, assertUsage, genPromise, getGlobalObject, objectAssign, checkType } from './utils.js';
const globalObject = getGlobalObject('createGetGlobalContextClient.ts', (() => {
    const { promise: globalContextInitialPromise, resolve: globalContextInitialPromiseResolve } = genPromise();
    return {
        globalContextInitialPromise,
        globalContextInitialPromiseResolve,
    };
})());
function createGetGlobalContextClient(virtualFileExportsGlobalEntry, isClientRouting, addGlobalContext) {
    assert(globalObject.isClientRouting === undefined || globalObject.isClientRouting === isClientRouting);
    globalObject.isClientRouting = isClientRouting;
    // Eagerly call onCreateGlobalContext() hook
    getGlobalContext();
    return getGlobalContext;
    async function getGlobalContext() {
        // HMR => virtualFileExportsGlobalEntry differ
        if (globalObject.virtualFileExportsGlobalEntry === virtualFileExportsGlobalEntry) {
            const globalContext = await globalObject.globalContextPromise;
            return globalContext;
        }
        else {
            globalObject.virtualFileExportsGlobalEntry = virtualFileExportsGlobalEntry;
        }
        // Create
        const globalContextPromise = createGlobalContextShared(virtualFileExportsGlobalEntry, globalObject, undefined, async (globalContext) => {
            const globalContextAddendum = {
                /**
                 * Whether the environment is client-side or server-side / pre-rendering.
                 *
                 * We recommend using `import.meta.env.SSR` instead, see https://vike.dev/globalContext
                 */
                isClientSide: true,
            };
            objectAssign(globalContextAddendum, getGlobalContextSerializedInHtml());
            objectAssign(globalContextAddendum, await addGlobalContext?.(globalContext));
            return globalContextAddendum;
        });
        globalObject.globalContextPromise = globalContextPromise;
        const globalContext = await globalContextPromise;
        assert(globalObject.globalContext === globalContext);
        globalObject.globalContextInitialPromiseResolve();
        // Return
        return globalContext;
    }
}
async function getGlobalContext() {
    await globalObject.globalContextInitialPromise;
    const globalContext = await globalObject.globalContextPromise;
    assert(globalContext);
    checkType(globalContext);
    return globalContext;
}
function getGlobalContextSync() {
    const { globalContext } = globalObject;
    assertUsage(globalContext, getGlobalContextSyncErrMsg);
    checkType(globalContext);
    return globalContext;
}
