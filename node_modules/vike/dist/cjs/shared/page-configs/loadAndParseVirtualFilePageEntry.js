"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.loadAndParseVirtualFilePageEntry = loadAndParseVirtualFilePageEntry;
const utils_js_1 = require("../utils.js");
const parsePageConfigsSerialized_js_1 = require("./serialize/parsePageConfigsSerialized.js");
async function loadAndParseVirtualFilePageEntry(pageConfig, isDev) {
    if ('isPageEntryLoaded' in pageConfig &&
        // We don't need to cache in dev, since Vite already caches the virtual module
        !isDev) {
        return pageConfig;
    }
    const { moduleId, moduleExportsPromise } = pageConfig.loadVirtualFilePageEntry();
    const virtualFileExportsPageEntry = await moduleExportsPromise;
    // `configValuesLoaded` is sometimes `undefined` https://github.com/vikejs/vike/discussions/2092
    if (!virtualFileExportsPageEntry)
        (0, utils_js_1.assert)(false, { moduleExportsPromise, virtualFileExportsPageEntry, moduleId });
    const configValues = parseVirtualFileExportsPageEntry(virtualFileExportsPageEntry);
    Object.assign(pageConfig.configValues, configValues);
    (0, utils_js_1.objectAssign)(pageConfig, { isPageEntryLoaded: true });
    return pageConfig;
}
function parseVirtualFileExportsPageEntry(virtualFileExportsPageEntry) {
    const configValues = (0, parsePageConfigsSerialized_js_1.parseConfigValuesSerialized)(virtualFileExportsPageEntry.configValuesSerialized);
    return configValues;
}
