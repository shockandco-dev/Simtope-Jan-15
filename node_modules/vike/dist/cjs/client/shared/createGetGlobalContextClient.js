"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getGlobalContext = getGlobalContext;
exports.getGlobalContextSync = getGlobalContextSync;
exports.createGetGlobalContextClient = createGetGlobalContextClient;
const createGlobalContextShared_js_1 = require("../../shared/createGlobalContextShared.js");
const getJsonSerializedInHtml_js_1 = require("./getJsonSerializedInHtml.js");
const utils_js_1 = require("./utils.js");
const globalObject = (0, utils_js_1.getGlobalObject)('createGetGlobalContextClient.ts', (() => {
    const { promise: globalContextInitialPromise, resolve: globalContextInitialPromiseResolve } = (0, utils_js_1.genPromise)();
    return {
        globalContextInitialPromise,
        globalContextInitialPromiseResolve,
    };
})());
function createGetGlobalContextClient(virtualFileExportsGlobalEntry, isClientRouting, addGlobalContext) {
    (0, utils_js_1.assert)(globalObject.isClientRouting === undefined || globalObject.isClientRouting === isClientRouting);
    globalObject.isClientRouting = isClientRouting;
    // Eagerly call onCreateGlobalContext() hook
    getGlobalContext();
    return getGlobalContext;
    async function getGlobalContext() {
        // HMR => virtualFileExportsGlobalEntry differ
        if (globalObject.virtualFileExportsGlobalEntry === virtualFileExportsGlobalEntry) {
            const globalContext = await globalObject.globalContextPromise;
            return globalContext;
        }
        else {
            globalObject.virtualFileExportsGlobalEntry = virtualFileExportsGlobalEntry;
        }
        // Create
        const globalContextPromise = (0, createGlobalContextShared_js_1.createGlobalContextShared)(virtualFileExportsGlobalEntry, globalObject, undefined, async (globalContext) => {
            const globalContextAddendum = {
                /**
                 * Whether the environment is client-side or server-side / pre-rendering.
                 *
                 * We recommend using `({}).SSR` instead, see https://vike.dev/globalContext
                 */
                isClientSide: true,
            };
            (0, utils_js_1.objectAssign)(globalContextAddendum, (0, getJsonSerializedInHtml_js_1.getGlobalContextSerializedInHtml)());
            (0, utils_js_1.objectAssign)(globalContextAddendum, await addGlobalContext?.(globalContext));
            return globalContextAddendum;
        });
        globalObject.globalContextPromise = globalContextPromise;
        const globalContext = await globalContextPromise;
        (0, utils_js_1.assert)(globalObject.globalContext === globalContext);
        globalObject.globalContextInitialPromiseResolve();
        // Return
        return globalContext;
    }
}
async function getGlobalContext() {
    await globalObject.globalContextInitialPromise;
    const globalContext = await globalObject.globalContextPromise;
    (0, utils_js_1.assert)(globalContext);
    (0, utils_js_1.checkType)(globalContext);
    return globalContext;
}
function getGlobalContextSync() {
    const { globalContext } = globalObject;
    (0, utils_js_1.assertUsage)(globalContext, createGlobalContextShared_js_1.getGlobalContextSyncErrMsg);
    (0, utils_js_1.checkType)(globalContext);
    return globalContext;
}
